<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONE TEAM - REPORT</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/report.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="app-container">
        <!-- ナビゲーション -->
        <nav class="nav-bar">
            <h1 class="nav-logo">ONE TEAM</h1>
            <div class="nav-links">
                <a href="report.html" class="nav-link active">REPORT</a>
                <a href="analyze.html" class="nav-link">ANALYZE</a>
                <a href="#" id="logoutBtn" class="nav-link">LOGOUT</a>
            </div>
        </nav>

        <!-- ヘッダーセクション -->
        <header class="header">
            <!-- 今日の名言 -->
            <div class="quote-section">
                <p class="quote-text" id="quoteText">「成功は最終的なものではなく、失敗は致命的なものではない。大切なのは続ける勇気だ。」</p>
                <p class="quote-author" id="quoteAuthor">- Winston Churchill</p>
            </div>

            <!-- 目標表示 -->
            <div class="targets">
                <div class="target-card">
                    <div class="target-label">TEAM GOAL</div>
                    <div class="target-value">¥<span id="teamGoal">5,000,000</span></div>
                </div>
                <div class="target-card">
                    <div class="target-label">YOUR GOAL</div>
                    <div class="target-value">¥<span id="yourGoal">500,000</span></div>
                </div>
            </div>
        </header>

        <!-- 日報入力セクション -->
        <main class="report-section">
            <h2 class="section-title">Today's Report</h2>
            
            <form id="reportForm" class="report-form">
                <div class="input-grid">
                    <div class="input-group">
                        <label for="offerCount">オファーの数</label>
                        <input type="number" id="offerCount" min="0" required>
                    </div>

                    <div class="input-group">
                        <label for="negotiationCount">商談数</label>
                        <input type="number" id="negotiationCount" min="0" required>
                    </div>

                    <div class="input-group">
                        <label for="closedDealCount">成約数</label>
                        <input type="number" id="closedDealCount" min="0" required>
                    </div>

                    <div class="input-group">
                        <label for="riatisViewCount">RIATIS視聴数</label>
                        <input type="number" id="riatisViewCount" min="0" required>
                    </div>

                    <div class="input-group">
                        <label for="crmOperationTime">CRM操作時間（分）</label>
                        <input type="number" id="crmOperationTime" min="0" required>
                    </div>
                </div>

                <div class="textarea-group">
                    <label for="nextAction">明日のネクストアクション</label>
                    <textarea id="nextAction" rows="4" placeholder="明日のアクションプランを入力してください..." required></textarea>
                </div>

                <button type="submit" class="btn-submit">
                    🚀 報告する
                </button>
            </form>
        </main>
    </div>

    <!-- 成功モーダル -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">🎉 素晴らしい！</h2>
            <p class="modal-message">今日も一日お疲れ様でした！</p>
            <p class="modal-submessage">あなたの努力がチームを前進させています</p>
            <button class="btn-primary" onclick="closeModal()">閉じる</button>
        </div>
    </div>

    <script>
        // Supabaseクライアントの初期化
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://omhucnthjctzyymrgaan.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9taHVjbnRoamN0enl5bXJnYWFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NDA5MTksImV4cCI6MjA4MzQxNjkxOX0.eJjpi5OG2ZecyNhYMBrR49T5sWbBE2dOwG6Y76-jG7g'
        );

        let currentUser = null;

        // 今日の名言をSupabaseから取得
        async function loadQuote() {
            const today = new Date();
            const dateKey = String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
            
            const { data, error } = await supabaseClient
                .from('quotes')
                .select('*')
                .eq('date_key', dateKey)
                .single();
            
            if (error || !data) {
                console.log('Quote not found for today, using default');
                document.getElementById('quoteText').textContent = '"成功は最終的なものではなく、失敗は致命的なものではない。大切なのは続ける勇気だ。"';
                document.getElementById('quoteAuthor').textContent = '- Winston Churchill';
                return;
            }
            
            document.getElementById('quoteText').textContent = `"${data.text_japanese}"`;
            document.getElementById('quoteAuthor').textContent = `- ${data.author}`;
        }

        // 目標値の読み込み
        async function loadGoals() {
            const today = new Date();
            const targetMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-01';
            
            // チーム目標を取得
            const { data: teamTarget, error: teamError } = await supabaseClient
                .from('monthly_targets')
                .select('target_revenue')
                .eq('target_month', targetMonth)
                .is('user_id', null)
                .single();
            
            if (!teamError && teamTarget) {
                document.getElementById('teamGoal').textContent = Number(teamTarget.target_revenue).toLocaleString();
            }
            
            // 個人目標を取得
            if (currentUser) {
                const { data: userTarget, error: userError } = await supabaseClient
                    .from('monthly_targets')
                    .select('target_revenue')
                    .eq('target_month', targetMonth)
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (!userError && userTarget) {
                    document.getElementById('yourGoal').textContent = Number(userTarget.target_revenue).toLocaleString();
                }
            }
        }

        // フォーム送信処理
        async function submitReport(e) {
            e.preventDefault();
            
            if (!currentUser) {
                alert('ログインセッションが切れています。再度ログインしてください。');
                window.location.href = 'index.html';
                return;
            }
            
            const reportData = {
                user_id: currentUser.id,
                report_date: new Date().toISOString().split('T')[0],
                offer_count: parseInt(document.getElementById('offerCount').value),
                negotiation_count: parseInt(document.getElementById('negotiationCount').value),
                closed_deal_count: parseInt(document.getElementById('closedDealCount').value),
                riatis_view_count: parseInt(document.getElementById('riatisViewCount').value),
                crm_operation_time: parseInt(document.getElementById('crmOperationTime').value),
                next_action_text: document.getElementById('nextAction').value
            };
            
            try {
                const { data, error } = await supabaseClient
                    .from('daily_reports')
                    .upsert(reportData, {
                        onConflict: 'user_id,report_date'
                    })
                    .select();
                
                if (error) {
                    console.error('Error submitting report:', error);
                    alert('報告の送信に失敗しました: ' + error.message);
                    return;
                }
                
                console.log('Report submitted successfully:', data);
                showSuccessModal();
                document.getElementById('reportForm').reset();
                
            } catch (error) {
                console.error('Error submitting report:', error);
                alert('報告の送信に失敗しました。もう一度お試しください。');
            }
        }

        // 成功モーダルの表示
        function showSuccessModal() {
            const modal = document.getElementById('successModal');
            modal.classList.add('show');
        }

        // モーダルを閉じる
        window.closeModal = function() {
            const modal = document.getElementById('successModal');
            modal.classList.remove('show');
        };

        // ログアウト処理
        async function logout() {
            if (confirm('ログアウトしますか？')) {
                await supabaseClient.auth.signOut();
                window.location.href = 'index.html';
            }
        }

        // ページ読み込み時の初期化
        async function initializePage() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (!session) {
                window.location.href = 'index.html';
                return;
            }
            
            currentUser = session.user;
            
            await loadQuote();
            await loadGoals();
            
            document.getElementById('reportForm').addEventListener('submit', submitReport);
            document.getElementById('logoutBtn').addEventListener('click', (e) => {
                e.preventDefault();
                logout();
            });
        }

        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
